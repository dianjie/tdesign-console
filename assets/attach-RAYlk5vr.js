import{an as O,d as H,f as p,a2 as j,r as l,o as V,m as $,w as t,a as e,b as d,q as _,M as F,i as J,as as Q,c as I,e as X,W as P,s as Y}from"./index-CqGaQ7t4.js";import{u as Z}from"./useSetting-CnYQd1RY.js";import{u as ee}from"./useDesign-CbWcZHFZ.js";import{u as te}from"./useRequset-Bj5fiv5N.js";import{a as ae}from"./oss-2LbzLkrS.js";import{u as K}from"./index-BidCcHov.js";const oe=(v,g,h)=>O.get({url:"/blade-resource/attach/list",params:{...h,current:v,size:g}},{joinTime:!1}),le=v=>O.post({url:"/blade-resource/attach/remove",params:{ids:v}},{joinParamsToUrl:!0,errorMessageMode:"message"}),ne=H({__name:"DialogUpload",props:{visible:{type:Boolean,default:!1}},emits:["update:visible","submit"],setup(v,{emit:g}){const h={attachFile:[]},N=v,R=p({attachFile:[{required:!0,message:"请选择附件",type:"error",trigger:"change"}]}),r=p(!1),s=p({...h}),f=p(null),m=p(!1),y=p(),x=g,w=K(({firstError:o})=>{o?F.warning(o):(m.value=!0,y.value.uploadFiles())},300),B=()=>{var o;(o=f.value)==null||o.reset()},T=()=>{r.value=!1};j(()=>r.value,o=>{x("update:visible",o)}),j(()=>N.visible,o=>{r.value=o});const b=({file:o})=>{F.error(`文件 ${o.name} 上传失败`),m.value=!1},M=async o=>{try{const n=await ae({file:o.raw});return{status:"success",response:{...n,url:n.link}}}catch{return{status:"fail",error:"上传失败"}}},q=()=>{x("submit",{}),F.success("上传成功"),m.value=!1};return(o,n)=>{const L=l("t-upload"),U=l("t-form-item"),S=l("t-col"),i=l("t-button"),a=l("t-row"),C=l("t-form"),k=l("t-dialog");return V(),$(k,{visible:r.value,"onUpdate:visible":n[1]||(n[1]=c=>r.value=c),header:"对象存储上传调试",width:580,footer:!1,onClosed:B},{body:t(()=>[e(C,{ref_key:"form",ref:f,data:s.value,rules:R.value,"label-width":100,disabled:m.value,onSubmit:d(w)},{default:t(()=>[e(a,{gutter:[0,28]},{default:t(()=>[e(S,{span:12},{default:t(()=>[e(U,{label:"附件上传",name:"attachFile"},{default:t(()=>[e(L,{ref_key:"uploadRef",ref:y,modelValue:s.value.attachFile,"onUpdate:modelValue":n[0]||(n[0]=c=>s.value.attachFile=c),"auto-upload":!1,"request-method":M,disabled:m.value,onFail:b,onSuccess:q},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(S,{span:12},{default:t(()=>[e(U,{style:{float:"right"}},{default:t(()=>[e(i,{variant:"outline",onClick:T},{default:t(()=>n[2]||(n[2]=[_("关闭")])),_:1}),e(i,{theme:"primary",disabled:m.value,type:"submit"},{default:t(()=>n[3]||(n[3]=[_("上传")])),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["data","rules","disabled","onSubmit"])]),_:1},8,["visible"])}}}),se=[{colKey:"row-select",type:"multiple",width:64,fixed:"left"},{colKey:"serial-number",title:"序号",width:80,align:"center",fixed:"left"},{title:"附件地址",colKey:"link"},{title:"附件域名",colKey:"domainUrl"},{title:"附件名称",colKey:"name"},{title:"附件原名",colKey:"originalName"},{title:"附件拓展名",colKey:"extension"},{title:"附件大小(KB)",colKey:"attachSize"},{fixed:"right",width:100,colKey:"op",title:"操作",align:"center"}],ie={class:"table-wrapper"},re=["onClick"],ve=H({__name:"attach",setup(v){const{tableVar:g}=ee(),{getTableHeaderAffixedTop:h,getLayoutContainer:N}=Z(),R={domainUrl:"",name:"",originalName:""},r=p([]),s=p({...R}),f=p(!1),m=p(!1),{fetchData:y,data:x,pagination:w,dataLoading:B}=te(oe,s.value,()=>{r.value=[]});J(()=>{y()});const T=({row:i})=>{window.open(`${i.link}`)},b=K(()=>{y()},300),M=i=>{r.value=i},q=i=>{w.value={...w.value,current:i.current||1,pageSize:i.pageSize},b()},o=()=>{r.value.length&&(f.value=!0)},L=K(async i=>{try{await le(i),f.value=!1,F.success("删除成功"),b()}catch{f.value=!1}},300),U=()=>{L(r.value)},S=K(()=>{m.value=!0},300);return(i,a)=>{const C=l("t-input"),k=l("t-form-item"),c=l("t-col"),A=l("t-row"),D=l("t-button"),W=l("t-form"),E=l("t-table"),G=l("t-dialog"),z=Q("auth");return V(),I("div",{class:Y(d(g))},[e(W,{ref:"form",data:s.value,"label-width":80,colon:"",style:{marginBottom:"8px"},onReset:d(b),onSubmit:d(b)},{default:t(()=>[e(A,null,{default:t(()=>[e(c,{span:10},{default:t(()=>[e(A,{gutter:[16,24]},{default:t(()=>[e(c,{span:4},{default:t(()=>[e(k,{label:"附件域名",name:"domainUrl"},{default:t(()=>[e(C,{modelValue:s.value.domainUrl,"onUpdate:modelValue":a[0]||(a[0]=u=>s.value.domainUrl=u),clearable:"",placeholder:"请输入附件域名"},null,8,["modelValue"])]),_:1})]),_:1}),e(c,{span:4},{default:t(()=>[e(k,{label:"附件名称",name:"name"},{default:t(()=>[e(C,{modelValue:s.value.name,"onUpdate:modelValue":a[1]||(a[1]=u=>s.value.name=u),clearable:"",placeholder:"请输入附件名称"},null,8,["modelValue"])]),_:1})]),_:1}),e(c,{span:4},{default:t(()=>[e(k,{label:"附件原名",name:"originalName"},{default:t(()=>[e(C,{modelValue:s.value.originalName,"onUpdate:modelValue":a[2]||(a[2]=u=>s.value.originalName=u),clearable:"",placeholder:"请输入附件原名"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(c,{span:2,class:"operation-wrapper"},{default:t(()=>[e(D,{theme:"primary",type:"submit",style:{marginLeft:"8px"}},{default:t(()=>a[5]||(a[5]=[_(" 查询 ")])),_:1}),e(D,{type:"reset",variant:"base",theme:"default"},{default:t(()=>a[6]||(a[6]=[_(" 重置 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["data","onReset","onSubmit"]),X("div",ie,[e(E,{data:d(x),columns:d(se),hover:!0,loading:d(B),pagination:d(w),"selected-row-keys":r.value,"header-affixed-top":{offsetTop:d(h),container:d(N)},"vertical-align":"top","row-key":"id",bordered:"",stripe:"",onPageChange:q,onSelectChange:M},{"top-content":t(()=>[e(A,{justify:"space-between",style:{"margin-bottom":"10px"}},{default:t(()=>[e(c,{flex:"0 0 auto"},{default:t(()=>[P((V(),$(D,{onClick:d(S)},{default:t(()=>a[7]||(a[7]=[_("上传")])),_:1},8,["onClick"])),[[z,"attach_upload"]]),P((V(),$(D,{theme:"danger",onClick:o},{default:t(()=>a[8]||(a[8]=[_("删除")])),_:1})),[[z,"attach_delete"]])]),_:1})]),_:1})]),op:t(u=>[P((V(),I("a",{class:"t-button-link",onClick:ue=>T(u)},a[9]||(a[9]=[_("下载")]),8,re)),[[z,"attach_download"]])]),_:1},8,["data","columns","loading","pagination","selected-row-keys","header-affixed-top"]),e(G,{visible:f.value,"onUpdate:visible":a[3]||(a[3]=u=>f.value=u),header:"确认删除当前所选数据？",onConfirm:U},null,8,["visible"]),e(ne,{visible:m.value,"onUpdate:visible":a[4]||(a[4]=u=>m.value=u)},null,8,["visible"])])],2)}}});export{ve as default};
