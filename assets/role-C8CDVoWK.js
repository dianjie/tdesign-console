import{g as Te,a as Ae,s as Se,b as De,c as Ne,d as Ue,e as Le,r as Re}from"./role-IyzmzPVr.js";import{g as Oe}from"./tenant-D0-jt9WM.js";import{u as Ke}from"./useSetting-BlFh-p_q.js";import{u as je}from"./useDesign-CbWcZHFZ.js";import{d as be,f as n,Q as ve,az as Be,a7 as fe,W as ue,r as d,o as h,m as H,w as t,a as e,s as _e,b as r,$ as A,q as v,a0 as $e,M as S,aA as qe,au as Fe,aB as Me,i as Ge,aw as ze,c as z,e as He,p as Qe,t as We,aC as Ee}from"./index-OjS_2jsV.js";import{u as Je}from"./useRequset-BqiZ8nsq.js";import{u as O}from"./index-BiO29gyn.js";const Pe=be({__name:"DialogForm",props:{visible:{type:Boolean,default:!1},editId:{type:String,default:""},actionType:{type:String,default:""},rowData:{type:Object,default:()=>({})}},emits:["update:visible","update:editId","update:actionType","submit"],setup(Q,{emit:W}){const K={roleName:"",roleAlias:"",tenantId:"",parentId:"",sort:void 0},b=Q,E=n({roleName:[{required:!0,message:"请输入角色名称",type:"error",trigger:"blur"}],roleAlias:[{required:!0,message:"请输入角色别名",type:"error",trigger:"blur"}],tenantId:[{required:!0,message:"请选择所属租户",type:"error",trigger:"change"}]}),J=ve(()=>`${{view:"查看",edit:"编辑",add:"新增"}[b.actionType]||""}角色`),j=ve(()=>({view:!0,edit:!1})[b.actionType]||!1),B=Be("tenantOptions")||[],_=n([]);async function p(i){const{tenantId:o}=r(b.rowData),k=await Ae(i||o);_.value=k}const c=n(!1),u=n({...K}),w=n(null),C=n(!1),g=W,D=({firstError:i})=>{if(i)S.warning(i);else{C.value=!0;const o={...u.value,id:b.editId};Se(o).then(()=>{g("submit",o),S.success("提交成功"),c.value=!1}).finally(()=>{C.value=!1})}},P=()=>{u.value={...K},ue(()=>{g("update:editId",""),g("update:actionType","")})},X=()=>{c.value=!1};fe(()=>c.value,i=>{g("update:visible",i)}),fe(()=>b.visible,i=>{i&&p(),i&&b.editId&&ue(()=>{Te(b.editId).then(o=>{u.value={...o}})}),ue(()=>{var o;(o=w.value)==null||o.clearValidate()}),c.value=i});const I=O(i=>{p(i),u.value.parentId="0"},500);return(i,o)=>{const k=d("t-input"),f=d("t-form-item"),y=d("t-col"),de=d("t-select"),$=d("t-tree-select"),Y=d("t-input-number"),x=d("t-button"),V=d("t-row"),q=d("t-form"),Z=d("t-dialog");return h(),H(Z,{visible:c.value,"onUpdate:visible":o[5]||(o[5]=m=>c.value=m),header:J.value,width:780,footer:!1,onClosed:P},{body:t(()=>[e(q,{ref_key:"form",ref:w,class:_e({"xy-form__detail":Q.actionType==="view"}),data:u.value,rules:E.value,"label-width":100,disabled:j.value||C.value,onSubmit:D},{default:t(()=>[e(V,{gutter:[0,28]},{default:t(()=>[e(y,{span:12},{default:t(()=>[e(f,{label:"角色名称",name:"roleName"},{default:t(()=>[e(k,{modelValue:u.value.roleName,"onUpdate:modelValue":o[0]||(o[0]=m=>u.value.roleName=m),clearable:"",placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(f,{label:"角色别名",name:"roleAlias"},{default:t(()=>[e(k,{modelValue:u.value.roleAlias,"onUpdate:modelValue":o[1]||(o[1]=m=>u.value.roleAlias=m),clearable:"",placeholder:"请输入角色别名"},null,8,["modelValue"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(f,{label:"所属租户",name:"tenantId"},{default:t(()=>[e(de,{modelValue:u.value.tenantId,"onUpdate:modelValue":o[2]||(o[2]=m=>u.value.tenantId=m),options:r(B),keys:{value:"tenantId",label:"tenantName"},clearable:"",placeholder:"请选择所属租户",onChange:r(I)},null,8,["modelValue","options","onChange"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(f,{label:"上级角色",name:"parentId"},{default:t(()=>[e($,{modelValue:u.value.parentId,"onUpdate:modelValue":o[3]||(o[3]=m=>u.value.parentId=m),data:_.value,"tree-props":{keys:{label:"title",value:"id",children:"children"}},clearable:"",placeholder:"请选择上级角色"},null,8,["modelValue","data"])]),_:1})]),_:1}),e(y,{span:12},{default:t(()=>[e(f,{label:"角色排序",name:"sort"},{default:t(()=>[e(Y,{modelValue:u.value.sort,"onUpdate:modelValue":o[4]||(o[4]=m=>u.value.sort=m),theme:"column",placeholder:"请输入角色排序",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),A(e(y,{span:12},{default:t(()=>[e(f,{style:{float:"right"}},{default:t(()=>[e(x,{variant:"outline",onClick:X},{default:t(()=>[v("取消")]),_:1}),e(x,{theme:"primary",type:"submit"},{default:t(()=>[v("确定")]),_:1})]),_:1})]),_:1},512),[[$e,!j.value]])]),_:1})]),_:1},8,["class","data","rules","disabled"])]),_:1},8,["visible","header"])}}}),Xe=[{colKey:"row-select",type:"multiple",width:64,fixed:"left"},{colKey:"serial-number",title:"序号",width:80,align:"center",fixed:"left"},{colKey:"roleName",title:"角色名称"},{colKey:"tenantId",title:"所属租户"},{colKey:"roleAlias",title:"角色别名"},{colKey:"sort",title:"角色排序"},{fixed:"right",width:180,colKey:"op",title:"操作",align:"center"}],Ye={class:"table-wrapper"},Ze=["onClick"],et=["onClick"],tt=["onClick"],rt=be({__name:"role",setup(Q){const{tableVar:W}=je(),{getTableHeaderAffixedTop:K,getLayoutContainer:b}=Ke(),{hasRole:E}=qe(),J={roleAlias:"",tenantId:"",roleName:""},j=Fe({childrenKey:"children",treeNodeColumnIndex:2}),B=n(null),_=n({}),p=n([]),c=n({...J}),u=n(!1),w=n(!1),C=n(""),g=n(""),{fetchData:D,data:P,dataLoading:X}=Je(De,c.value,()=>{p.value=[]},!1),I=n([]);async function i(){const s=await Oe();I.value=s}Me("tenantOptions",I),Ge(()=>{i(),D()});const o=({row:s},a)=>{_.value=s,C.value=s.id,g.value=a,w.value=!0},k=({row:s})=>{x.value=s.id,V.value="one",u.value=!0},f=O(()=>{D()},300),y=s=>{p.value=s},$=O(async s=>{try{await Re(s),u.value=!1,S.success("删除成功"),q(),f()}catch{u.value=!1}},300),Y=()=>{p.value.length&&(V.value="check",u.value=!0)},x=n(-1),V=n(),q=()=>{x.value=-1,V.value=""},Z=()=>{V.value==="check"&&$(p.value),V.value==="one"&&$([`${x.value}`])},m=()=>{q()},F=n(!1),N=n([]),ie=n([]),ee=n([]),M=n([]),re=n([]),te=n([]),G=n([]),ce=n([]),ae=n([]),ge=O(()=>{if(!p.value.length){S.warning("至少选择一条数据");return}if(p.value.length!==1){S.warning("只能选择一条数据");return}N.value=[],Ne().then(s=>(ie.value=s.menu,re.value=s.dataScope,ce.value=s.apiScope,Ue(p.value.join()))).then(s=>{N.value=s.menu,M.value=s.dataScope,G.value=s.apiScope,F.value=!0})},300),ye=()=>{Le(p.value,N.value,M.value,G.value).then(()=>{F.value=!1,S.success("操作成功")})},he=()=>{ee.value=[],te.value=[],ae.value=[]},Ce=O(ye,300),Ve=s=>{var U;const{parentId:a}=r(_.value);s.parentId!==a?D():s.id&&((U=B.value)==null||U.setData(s.id,{..._.value,...s})),_.value={}};return(s,a)=>{const U=d("t-input"),le=d("t-form-item"),T=d("t-col"),we=d("t-select"),ne=d("t-row"),L=d("t-button"),Ie=d("t-form"),ke=d("t-enhanced-table"),me=d("t-dialog"),oe=d("t-tree"),se=d("t-tab-panel"),xe=d("t-tabs"),R=ze("auth");return h(),z("div",{class:_e(r(W))},[e(Ie,{ref:"form",data:c.value,"label-width":80,colon:"",style:{marginBottom:"8px"},onReset:r(f),onSubmit:r(f)},{default:t(()=>[e(ne,null,{default:t(()=>[e(T,{span:10},{default:t(()=>[e(ne,{gutter:[16,24]},{default:t(()=>[e(T,{span:4},{default:t(()=>[e(le,{label:"角色名称",name:"roleName"},{default:t(()=>[e(U,{modelValue:c.value.roleName,"onUpdate:modelValue":a[0]||(a[0]=l=>c.value.roleName=l),clearable:"",placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1})]),_:1}),e(T,{span:4},{default:t(()=>[e(le,{label:"所属租户",name:"tenantId"},{default:t(()=>[e(we,{modelValue:c.value.tenantId,"onUpdate:modelValue":a[1]||(a[1]=l=>c.value.tenantId=l),options:I.value,keys:{value:"tenantId",label:"tenantName"},clearable:"",placeholder:"请选择所属租户"},null,8,["modelValue","options"])]),_:1})]),_:1}),e(T,{span:4},{default:t(()=>[e(le,{label:"角色别名",name:"roleAlias"},{default:t(()=>[e(U,{modelValue:c.value.roleAlias,"onUpdate:modelValue":a[2]||(a[2]=l=>c.value.roleAlias=l),clearable:"",placeholder:"请输入角色别名"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(T,{span:2,class:"operation-wrapper"},{default:t(()=>[e(L,{theme:"primary",type:"submit",style:{marginLeft:"8px"}},{default:t(()=>[v(" 查询 ")]),_:1}),e(L,{type:"reset",variant:"base",theme:"default"},{default:t(()=>[v(" 重置 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["data","onReset","onSubmit"]),He("div",Ye,[e(ke,{ref_key:"enhancedTable",ref:B,data:r(P),columns:r(Xe),hover:!0,loading:r(X),tree:j,"selected-row-keys":p.value,"header-affixed-top":{offsetTop:r(K),container:r(b)},"vertical-align":"top","row-key":"id",bordered:"",stripe:"",onSelectChange:y},{"top-content":t(()=>[e(ne,{justify:"space-between",style:{"margin-bottom":"10px"}},{default:t(()=>[e(T,{flex:"0 0 auto"},{default:t(()=>[A((h(),H(L,{onClick:a[3]||(a[3]=l=>o({row:{}},"add"))},{default:t(()=>[v("新增")]),_:1})),[[R,"role_add"]]),A((h(),H(L,{theme:"danger",onClick:Y},{default:t(()=>[v("删除")]),_:1})),[[R,"role_delete"]]),r(E)(["administrator","admin"])?(h(),H(L,{key:0,variant:"outline",onClick:r(ge)},{default:t(()=>[v(" 权限配置 ")]),_:1},8,["onClick"])):Qe("",!0)]),_:1})]),_:1})]),tenantId:t(({row:l})=>[v(We(r(Ee)(I.value,l.tenantId,{id:"tenantId",name:"tenantName"})),1)]),op:t(l=>[A((h(),z("a",{class:"t-button-link",onClick:pe=>o(l,"view")},[v("查看")],8,Ze)),[[R,"role_view"]]),A((h(),z("a",{class:"t-button-link",onClick:pe=>o(l,"edit")},[v("编辑")],8,et)),[[R,"role_edit"]]),A((h(),z("a",{class:"t-button-link",onClick:pe=>k(l)},[v("删除")],8,tt)),[[R,"role_delete"]])]),_:1},8,["data","columns","loading","tree","selected-row-keys","header-affixed-top"]),e(me,{visible:u.value,"onUpdate:visible":a[4]||(a[4]=l=>u.value=l),header:"确认删除当前所选数据？","on-cancel":m,onConfirm:Z},null,8,["visible"]),e(Pe,{visible:w.value,"onUpdate:visible":a[5]||(a[5]=l=>w.value=l),editId:C.value,"onUpdate:editId":a[6]||(a[6]=l=>C.value=l),actionType:g.value,"onUpdate:actionType":a[7]||(a[7]=l=>g.value=l),"row-data":_.value,onSubmit:Ve},null,8,["visible","editId","actionType","row-data"]),e(me,{visible:F.value,"onUpdate:visible":a[14]||(a[14]=l=>F.value=l),header:"角色权限配置",onCancel:he,onConfirm:r(Ce)},{default:t(()=>[e(xe,{"default-value":1},{default:t(()=>[e(se,{value:1,label:"菜单权限"},{default:t(()=>[e(oe,{modelValue:N.value,"onUpdate:modelValue":a[8]||(a[8]=l=>N.value=l),expanded:ee.value,"onUpdate:expanded":a[9]||(a[9]=l=>ee.value=l),data:ie.value,hover:"",keys:{value:"id",label:"title"},checkable:!0,style:{"margin-top":"15px"}},null,8,["modelValue","expanded","data"])]),_:1}),e(se,{value:2,label:"数据权限"},{default:t(()=>[e(oe,{modelValue:M.value,"onUpdate:modelValue":a[10]||(a[10]=l=>M.value=l),expanded:te.value,"onUpdate:expanded":a[11]||(a[11]=l=>te.value=l),data:re.value,hover:"",keys:{value:"id",label:"title"},checkable:!0,style:{"margin-top":"15px"}},null,8,["modelValue","expanded","data"])]),_:1}),e(se,{value:3,label:"接口权限"},{default:t(()=>[e(oe,{modelValue:G.value,"onUpdate:modelValue":a[12]||(a[12]=l=>G.value=l),expanded:ae.value,"onUpdate:expanded":a[13]||(a[13]=l=>ae.value=l),data:ce.value,hover:"",keys:{value:"id",label:"title"},checkable:!0,style:{"margin-top":"15px"}},null,8,["modelValue","expanded","data"])]),_:1})]),_:1})]),_:1},8,["visible","onConfirm"])])],2)}}});export{rt as default};
