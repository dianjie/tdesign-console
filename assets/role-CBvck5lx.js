import{g as he,a as Ae,s as Se,b as De,c as Ne,d as Ue,e as Le,r as Re}from"./role-FMd1SLvK.js";import{g as Oe}from"./tenant-BajJal67.js";import{u as Ke}from"./useSetting-CnYQd1RY.js";import{u as je}from"./useDesign-CbWcZHFZ.js";import{d as be,f as o,J as ce,av as Be,a2 as fe,Q as ue,r as d,o as C,m as H,w as a,a as t,s as _e,b as r,W as A,q as c,X as $e,M as S,aw as qe,aq as Fe,ax as Me,i as Ge,as as ze,c as z,e as He,p as Je,t as Qe,ay as We}from"./index-CqGaQ7t4.js";import{u as Xe}from"./useRequset-Bj5fiv5N.js";import{u as O}from"./index-BidCcHov.js";const Ee=be({__name:"DialogForm",props:{visible:{type:Boolean,default:!1},editId:{type:String,default:""},actionType:{type:String,default:""},rowData:{type:Object,default:()=>({})}},emits:["update:visible","update:editId","update:actionType","submit"],setup(J,{emit:Q}){const K={roleName:"",roleAlias:"",tenantId:"",parentId:"",sort:void 0},b=J,W=o({roleName:[{required:!0,message:"请输入角色名称",type:"error",trigger:"blur"}],roleAlias:[{required:!0,message:"请输入角色别名",type:"error",trigger:"blur"}],tenantId:[{required:!0,message:"请选择所属租户",type:"error",trigger:"change"}]}),X=ce(()=>`${{view:"查看",edit:"编辑",add:"新增"}[b.actionType]||""}角色`),j=ce(()=>({view:!0,edit:!1})[b.actionType]||!1),B=Be("tenantOptions")||[],_=o([]);async function v(i){const{tenantId:n}=r(b.rowData),x=await Ae(i||n);_.value=x}const m=o(!1),u=o({...K}),I=o(null),V=o(!1),g=Q,D=({firstError:i})=>{if(i)S.warning(i);else{V.value=!0;const n={...u.value,id:b.editId};Se(n).then(()=>{g("submit",n),S.success("提交成功"),m.value=!1}).finally(()=>{V.value=!1})}},E=()=>{u.value={...K},ue(()=>{g("update:editId",""),g("update:actionType","")})},P=()=>{m.value=!1};fe(()=>m.value,i=>{g("update:visible",i)}),fe(()=>b.visible,i=>{i&&v(),i&&b.editId&&ue(()=>{he(b.editId).then(n=>{u.value={...n}})}),ue(()=>{var n;(n=I.value)==null||n.clearValidate()}),m.value=i});const k=O(i=>{v(i),u.value.parentId="0"},500);return(i,n)=>{const x=d("t-input"),f=d("t-form-item"),y=d("t-col"),de=d("t-select"),$=d("t-tree-select"),Y=d("t-input-number"),T=d("t-button"),w=d("t-row"),q=d("t-form"),Z=d("t-dialog");return C(),H(Z,{visible:m.value,"onUpdate:visible":n[5]||(n[5]=p=>m.value=p),header:X.value,width:780,footer:!1,onClosed:E},{body:a(()=>[t(q,{ref_key:"form",ref:I,class:_e({"xy-form__detail":J.actionType==="view"}),data:u.value,rules:W.value,"label-width":100,disabled:j.value||V.value,onSubmit:D},{default:a(()=>[t(w,{gutter:[0,28]},{default:a(()=>[t(y,{span:12},{default:a(()=>[t(f,{label:"角色名称",name:"roleName"},{default:a(()=>[t(x,{modelValue:u.value.roleName,"onUpdate:modelValue":n[0]||(n[0]=p=>u.value.roleName=p),clearable:"",placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(y,{span:12},{default:a(()=>[t(f,{label:"角色别名",name:"roleAlias"},{default:a(()=>[t(x,{modelValue:u.value.roleAlias,"onUpdate:modelValue":n[1]||(n[1]=p=>u.value.roleAlias=p),clearable:"",placeholder:"请输入角色别名"},null,8,["modelValue"])]),_:1})]),_:1}),t(y,{span:12},{default:a(()=>[t(f,{label:"所属租户",name:"tenantId"},{default:a(()=>[t(de,{modelValue:u.value.tenantId,"onUpdate:modelValue":n[2]||(n[2]=p=>u.value.tenantId=p),options:r(B),keys:{value:"tenantId",label:"tenantName"},clearable:"",placeholder:"请选择所属租户",onChange:r(k)},null,8,["modelValue","options","onChange"])]),_:1})]),_:1}),t(y,{span:12},{default:a(()=>[t(f,{label:"上级角色",name:"parentId"},{default:a(()=>[t($,{modelValue:u.value.parentId,"onUpdate:modelValue":n[3]||(n[3]=p=>u.value.parentId=p),data:_.value,"tree-props":{keys:{label:"title",value:"id",children:"children"}},clearable:"",placeholder:"请选择上级角色"},null,8,["modelValue","data"])]),_:1})]),_:1}),t(y,{span:12},{default:a(()=>[t(f,{label:"角色排序",name:"sort"},{default:a(()=>[t(Y,{modelValue:u.value.sort,"onUpdate:modelValue":n[4]||(n[4]=p=>u.value.sort=p),theme:"column",placeholder:"请输入角色排序",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),A(t(y,{span:12},{default:a(()=>[t(f,{style:{float:"right"}},{default:a(()=>[t(T,{variant:"outline",onClick:P},{default:a(()=>n[6]||(n[6]=[c("取消")])),_:1}),t(T,{theme:"primary",type:"submit"},{default:a(()=>n[7]||(n[7]=[c("确定")])),_:1})]),_:1})]),_:1},512),[[$e,!j.value]])]),_:1})]),_:1},8,["class","data","rules","disabled"])]),_:1},8,["visible","header"])}}}),Pe=[{colKey:"row-select",type:"multiple",width:64,fixed:"left"},{colKey:"serial-number",title:"序号",width:80,align:"center",fixed:"left"},{colKey:"roleName",title:"角色名称"},{colKey:"tenantId",title:"所属租户"},{colKey:"roleAlias",title:"角色别名"},{colKey:"sort",title:"角色排序"},{fixed:"right",width:180,colKey:"op",title:"操作",align:"center"}],Ye={class:"table-wrapper"},Ze=["onClick"],et=["onClick"],tt=["onClick"],rt=be({__name:"role",setup(J){const{tableVar:Q}=je(),{getTableHeaderAffixedTop:K,getLayoutContainer:b}=Ke(),{hasRole:W}=qe(),X={roleAlias:"",tenantId:"",roleName:""},j=Fe({childrenKey:"children",treeNodeColumnIndex:2}),B=o(null),_=o({}),v=o([]),m=o({...X}),u=o(!1),I=o(!1),V=o(""),g=o(""),{fetchData:D,data:E,dataLoading:P}=Xe(De,m.value,()=>{v.value=[]},!1),k=o([]);async function i(){const s=await Oe();k.value=s}Me("tenantOptions",k),Ge(()=>{i(),D()});const n=({row:s},e)=>{_.value=s,V.value=s.id,g.value=e,I.value=!0},x=({row:s})=>{T.value=s.id,w.value="one",u.value=!0},f=O(()=>{D()},300),y=s=>{v.value=s},$=O(async s=>{try{await Re(s),u.value=!1,S.success("删除成功"),q(),f()}catch{u.value=!1}},300),Y=()=>{v.value.length&&(w.value="check",u.value=!0)},T=o(-1),w=o(),q=()=>{T.value=-1,w.value=""},Z=()=>{w.value==="check"&&$(v.value),w.value==="one"&&$([`${T.value}`])},p=()=>{q()},F=o(!1),N=o([]),ie=o([]),ee=o([]),M=o([]),re=o([]),te=o([]),G=o([]),me=o([]),ae=o([]),ge=O(()=>{if(!v.value.length){S.warning("至少选择一条数据");return}if(v.value.length!==1){S.warning("只能选择一条数据");return}N.value=[],Ne().then(s=>(ie.value=s.menu,re.value=s.dataScope,me.value=s.apiScope,Ue(v.value.join()))).then(s=>{N.value=s.menu,M.value=s.dataScope,G.value=s.apiScope,F.value=!0})},300),ye=()=>{Le(v.value,N.value,M.value,G.value).then(()=>{F.value=!1,S.success("操作成功")})},Ce=()=>{ee.value=[],te.value=[],ae.value=[]},Ve=O(ye,300),we=s=>{var U;const{parentId:e}=r(_.value);s.parentId!==e?D():s.id&&((U=B.value)==null||U.setData(s.id,{..._.value,...s})),_.value={}};return(s,e)=>{const U=d("t-input"),le=d("t-form-item"),h=d("t-col"),Ie=d("t-select"),ne=d("t-row"),L=d("t-button"),ke=d("t-form"),xe=d("t-enhanced-table"),pe=d("t-dialog"),oe=d("t-tree"),se=d("t-tab-panel"),Te=d("t-tabs"),R=ze("auth");return C(),z("div",{class:_e(r(Q))},[t(ke,{ref:"form",data:m.value,"label-width":80,colon:"",style:{marginBottom:"8px"},onReset:r(f),onSubmit:r(f)},{default:a(()=>[t(ne,null,{default:a(()=>[t(h,{span:10},{default:a(()=>[t(ne,{gutter:[16,24]},{default:a(()=>[t(h,{span:4},{default:a(()=>[t(le,{label:"角色名称",name:"roleName"},{default:a(()=>[t(U,{modelValue:m.value.roleName,"onUpdate:modelValue":e[0]||(e[0]=l=>m.value.roleName=l),clearable:"",placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(h,{span:4},{default:a(()=>[t(le,{label:"所属租户",name:"tenantId"},{default:a(()=>[t(Ie,{modelValue:m.value.tenantId,"onUpdate:modelValue":e[1]||(e[1]=l=>m.value.tenantId=l),options:k.value,keys:{value:"tenantId",label:"tenantName"},clearable:"",placeholder:"请选择所属租户"},null,8,["modelValue","options"])]),_:1})]),_:1}),t(h,{span:4},{default:a(()=>[t(le,{label:"角色别名",name:"roleAlias"},{default:a(()=>[t(U,{modelValue:m.value.roleAlias,"onUpdate:modelValue":e[2]||(e[2]=l=>m.value.roleAlias=l),clearable:"",placeholder:"请输入角色别名"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(h,{span:2,class:"operation-wrapper"},{default:a(()=>[t(L,{theme:"primary",type:"submit",style:{marginLeft:"8px"}},{default:a(()=>e[15]||(e[15]=[c(" 查询 ")])),_:1}),t(L,{type:"reset",variant:"base",theme:"default"},{default:a(()=>e[16]||(e[16]=[c(" 重置 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["data","onReset","onSubmit"]),He("div",Ye,[t(xe,{ref_key:"enhancedTable",ref:B,data:r(E),columns:r(Pe),hover:!0,loading:r(P),tree:j,"selected-row-keys":v.value,"header-affixed-top":{offsetTop:r(K),container:r(b)},"vertical-align":"top","row-key":"id",bordered:"",stripe:"",onSelectChange:y},{"top-content":a(()=>[t(ne,{justify:"space-between",style:{"margin-bottom":"10px"}},{default:a(()=>[t(h,{flex:"0 0 auto"},{default:a(()=>[A((C(),H(L,{onClick:e[3]||(e[3]=l=>n({row:{}},"add"))},{default:a(()=>e[17]||(e[17]=[c("新增")])),_:1})),[[R,"role_add"]]),A((C(),H(L,{theme:"danger",onClick:Y},{default:a(()=>e[18]||(e[18]=[c("删除")])),_:1})),[[R,"role_delete"]]),r(W)(["administrator","admin"])?(C(),H(L,{key:0,variant:"outline",onClick:r(ge)},{default:a(()=>e[19]||(e[19]=[c(" 权限配置 ")])),_:1},8,["onClick"])):Je("",!0)]),_:1})]),_:1})]),tenantId:a(({row:l})=>[c(Qe(r(We)(k.value,l.tenantId,{id:"tenantId",name:"tenantName"})),1)]),op:a(l=>[A((C(),z("a",{class:"t-button-link",onClick:ve=>n(l,"view")},e[20]||(e[20]=[c("查看")]),8,Ze)),[[R,"role_view"]]),A((C(),z("a",{class:"t-button-link",onClick:ve=>n(l,"edit")},e[21]||(e[21]=[c("编辑")]),8,et)),[[R,"role_edit"]]),A((C(),z("a",{class:"t-button-link",onClick:ve=>x(l)},e[22]||(e[22]=[c("删除")]),8,tt)),[[R,"role_delete"]])]),_:1},8,["data","columns","loading","tree","selected-row-keys","header-affixed-top"]),t(pe,{visible:u.value,"onUpdate:visible":e[4]||(e[4]=l=>u.value=l),header:"确认删除当前所选数据？","on-cancel":p,onConfirm:Z},null,8,["visible"]),t(Ee,{visible:I.value,"onUpdate:visible":e[5]||(e[5]=l=>I.value=l),editId:V.value,"onUpdate:editId":e[6]||(e[6]=l=>V.value=l),actionType:g.value,"onUpdate:actionType":e[7]||(e[7]=l=>g.value=l),"row-data":_.value,onSubmit:we},null,8,["visible","editId","actionType","row-data"]),t(pe,{visible:F.value,"onUpdate:visible":e[14]||(e[14]=l=>F.value=l),header:"角色权限配置",onCancel:Ce,onConfirm:r(Ve)},{default:a(()=>[t(Te,{"default-value":1},{default:a(()=>[t(se,{value:1,label:"菜单权限"},{default:a(()=>[t(oe,{modelValue:N.value,"onUpdate:modelValue":e[8]||(e[8]=l=>N.value=l),expanded:ee.value,"onUpdate:expanded":e[9]||(e[9]=l=>ee.value=l),data:ie.value,hover:"",keys:{value:"id",label:"title"},checkable:!0,style:{"margin-top":"15px"}},null,8,["modelValue","expanded","data"])]),_:1}),t(se,{value:2,label:"数据权限"},{default:a(()=>[t(oe,{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=l=>M.value=l),expanded:te.value,"onUpdate:expanded":e[11]||(e[11]=l=>te.value=l),data:re.value,hover:"",keys:{value:"id",label:"title"},checkable:!0,style:{"margin-top":"15px"}},null,8,["modelValue","expanded","data"])]),_:1}),t(se,{value:3,label:"接口权限"},{default:a(()=>[t(oe,{modelValue:G.value,"onUpdate:modelValue":e[12]||(e[12]=l=>G.value=l),expanded:ae.value,"onUpdate:expanded":e[13]||(e[13]=l=>ae.value=l),data:me.value,hover:"",keys:{value:"id",label:"title"},checkable:!0,style:{"margin-top":"15px"}},null,8,["modelValue","expanded","data"])]),_:1})]),_:1})]),_:1},8,["visible","onConfirm"])])],2)}}});export{rt as default};
